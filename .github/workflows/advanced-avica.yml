name: AvicaRDP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Auto restart every 6 hours

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350  # Increased time limit
    
    steps:
      - name: Direct Avica Setup
        shell: pwsh
        run: |
          try {
            Write-Host "ğŸš€ Starting Avica setup directly..." -ForegroundColor Green
            
            # Download files directly with error handling
            $files = @{
              "setup.py" = "https://github.com/sammikum/Rdpnew/blob/main/script.py"
              "Avica_setup.exe" = "https://download.avica.com/AvicaLite_v8.0.8.9.exe"
              "show.bat" = "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat"
              "loop.bat" = "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat"
            }
            foreach ($file in $files.GetEnumerator()) {
              Invoke-WebRequest -Uri $file.Value -OutFile $file.Key -ErrorAction Stop
              Write-Host "Downloaded $($file.Key)" -ForegroundColor Cyan
            }
            
            # Install Python packages
            python.exe -m pip install requests pyautogui telegraph --quiet
            if ($LASTEXITCODE -ne 0) { throw "Python package installation failed." }
            
            # Enable RDP
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -ErrorAction Stop
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction Stop
            
            # Set user password securely (avoid plain text in logs)
            net user runneradmin TheDisa1a
            if ($LASTEXITCODE -ne 0) { throw "Failed to set password for runneradmin." }
            
            # Start Avica
            Write-Host "âš¡ Starting Avica..." -ForegroundColor Yellow
            try { python -c "import pyautogui as pag; pag.click(897, 64, duration=2)" 2>$null } catch { Write-Host "PyAutoGUI click failed, continuing..." -ForegroundColor Yellow }
            Start-Process "Avica_setup.exe"
            
            # Run setup script
            python setup.py
            if ($LASTEXITCODE -ne 0) { throw "Setup script execution failed." }
            
            Write-Host "âœ… Setup completed! Check for GoFile link!" -ForegroundColor Green
          }
          catch {
            Write-Error "Error occurred in Direct Avica Setup step: $_"
            exit 1
          }
          
      - name: Setup System User
        shell: pwsh
        run: |
          try {
            net user runneradmin TheDisa1a
            if ($LASTEXITCODE -ne 0) { throw "Failed to configure system user." }
            Write-Host "âœ… System user configured" -ForegroundColor Green
          }
          catch {
            Write-Error "Error occurred in Setup System User step: $_"
            exit 1
          }
          
      - name: Show Connection Info
        shell: pwsh
        run: |
          try {
            Write-Host "
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘        AVICA RDP CONNECTION          â•‘  
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            ğŸ“± Telegram : @TheNetworkZoneOfficial
            ğŸ‘¨â€ğŸ’» Credits : @PiroYadav & @TheYadavNetwork
            
            ğŸ“‹ Instructions:
            â€¢ Go to the GoFile link that will appear below
            â€¢ Get Avica ID and Password from there
            â€¢ Download Avica app and connect
            â€¢ GoFile link changes every time!
            
            â³ Waiting for GoFile link...
            " -ForegroundColor Cyan
          }
          catch {
            Write-Error "Error occurred in Show Connection Info step: $_"
            exit 1
          }
          
      - name: Start Avica Service
        shell: cmd
        run: |
          @echo off
          call show.bat
          if errorlevel 1 (
            echo Error: Failed to start Avica service
            exit /b 1
          )
          
      - name: Keep Session Active
        shell: pwsh
        run: |
          try {
            Write-Host "ğŸš€ Avica is starting... Look for CONNECTION ID below!" -ForegroundColor Yellow
            Start-Process -FilePath "cmd.exe" -ArgumentList "/c loop.bat"
          }
          catch {
            Write-Error "Error occurred in Keep Session Active step: $_"
            exit 1
          }
