name: AvicaRDP

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Auto restart every 6 hours
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - '**.bat'
      - '.github/workflows/**'

env:
  AVICA_VERSION: '8.0.8.9'
  PYTHON_VERSION: '3.11'

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350  # Increased time limit
    env:
      RDP_PASSWORD: ${{ secrets.RDP_PASSWORD || 'TheDisa1a' }}  # Use secret if available
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: ./repo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          try {
            python -m pip install --quiet requests pyautogui telegraph
            Write-Host "✅ Python dependencies installed" -ForegroundColor Green
          } catch {
            Write-Host "❌ Error installing dependencies: $_" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
        continue-on-error: true  # Proceed to allow debugging

      - name: Create Fallback Scripts
        run: |
          if (-Not (Test-Path ./repo/setup.py)) {
            Write-Host "⚠️ setup.py not found in repo, creating fallback..." -ForegroundColor Yellow
            Set-Content -Path setup.py -Value @"
import requests
import pyautogui
import telegraph
print('Fallback setup.py: Configure Avica and generate GoFile link here')
# Placeholder: Add logic to configure Avica, generate GoFile link
"@
          }
          if (-Not (Test-Path ./repo/show.bat)) {
            Write-Host "⚠️ show.bat not found in repo, creating fallback..." -ForegroundColor Yellow
            Set-Content -Path show.bat -Value 'echo Displaying Avica connection details...'
          }
          if (-Not (Test-Path ./repo/loop.bat)) {
            Write-Host "⚠️ loop.bat not found in repo, creating fallback..." -ForegroundColor Yellow
            Set-Content -Path loop.bat -Value @"
:loop
ping 127.0.0.1 -n 60 > nul
goto loop
"@
          }
        shell: pwsh

      - name: Download Avica and Scripts
        run: |
          $downloadUrlBase = "https://gitlab.com/userup908/my-rdp/-/raw/main/"
          try {
            if (Test-Path ./repo/setup.py) {
              Copy-Item ./repo/setup.py -Destination . -ErrorAction Stop
            } else {
              Invoke-WebRequest -Uri "${downloadUrlBase}setup.py" -OutFile "setup.py" -ErrorAction Stop
            }
            Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v${env:AVICA_VERSION}.exe" -OutFile "Avica_setup.exe" -ErrorAction Stop
            if (Test-Path ./repo/show.bat) {
              Copy-Item ./repo/show.bat -Destination . -ErrorAction Stop
            } else {
              Invoke-WebRequest -Uri "${downloadUrlBase}show.bat" -OutFile "show.bat" -ErrorAction Stop
            }
            if (Test-Path ./repo/loop.bat) {
              Copy-Item ./repo/loop.bat -Destination . -ErrorAction Stop
            } else {
              Invoke-WebRequest -Uri "${downloadUrlBase}loop.bat" -OutFile "loop.bat" -ErrorAction Stop
            }
            Write-Host "✅ Files downloaded successfully" -ForegroundColor Green
          } catch {
            Write-Host "❌ Error downloading files: $_" -ForegroundColor Red
            exit 1
          }
        shell: pwsh

      - name: Enable RDP
        run: |
          try {
            Write-Host "🚀 Enabling RDP..." -ForegroundColor Green
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -ErrorAction Stop
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -Enabled True -ErrorAction Stop
            net user runneradmin $env:RDP_PASSWORD
            Write-Host "✅ RDP enabled and user configured" -ForegroundColor Green
          } catch {
            Write-Host "❌ Error enabling RDP: $_" -ForegroundColor Red
            exit 1
          }
        shell: pwsh

      - name: Start Avica Service
        run: |
          try {
            Write-Host "⚡ Starting Avica..." -ForegroundColor Yellow
            python -c "import pyautogui; pyautogui.FAILSAFE = False; pyautogui.click(897, 64, duration=2)" 2>$null || true
            Start-Process "Avica_setup.exe" -Wait:$false -ErrorAction Stop
            Start-Sleep -Seconds 10
            python setup.py
            Write-Host "✅ Avica setup completed! Check for GoFile link!" -ForegroundColor Green
          } catch {
            Write-Host "❌ Error starting Avica: $_" -ForegroundColor Red
            exit 1
          }
        shell: pwsh

      - name: Display Connection Info
        if: always()  # Run even if previous steps fail
        run: |
          Write-Host "
          ╔══════════════════════════════════════╗
          ║        AVICA RDP CONNECTION          ║  
          ╚══════════════════════════════════════╝
          
          📱 Telegram: @TheNetworkZoneOfficial
          👨‍💻 Credits: @PiroYadav & @TheYadavNetwork
          
          📋 Instructions:
          • Go to the GoFile link in the logs below
          • Get Avica ID and Password from there
          • Download Avica app and connect
          • GoFile link changes every time!
          
          ⏳ Waiting for GoFile link...
          " -ForegroundColor Cyan
        shell: pwsh

      - name: Run Display Script
        run: |
          try {
            cmd /c show.bat
          } catch {
            Write-Host "❌ Error running show.bat: $_" -ForegroundColor Red
          }
        shell: pwsh
        if: always()

      - name: Keep Session Active
        run: |
          Write-Host "🚀 Avica is running... Look for CONNECTION ID in logs!" -ForegroundColor Yellow
          try {
            cmd /c loop.bat
          } catch {
            Write-Host "❌ Error running loop.bat: $_" -ForegroundColor Red
          }
        shell: pwsh
        timeout-minutes: 340  # Leave buffer for timeout
        if: always()

      - name: Upload Artifacts (Logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rdp-logs-windows
          path: |
            *.log
            setup.py.output  # Assuming setup.py generates this
          retention-days: 1
