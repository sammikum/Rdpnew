name: AvicaRDP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Auto restart every 6 hours

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Direct Avica Setup
        shell: pwsh
        run: |
          Write-Host '🚀 Starting Avica setup directly...' -ForegroundColor Green

          # Download files directly
          Invoke-WebRequest -Uri 'https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py' -OutFile 'setup.py'
          Invoke-WebRequest -Uri 'https://download.avica.com/AvicaLite_v8.0.8.9.exe' -OutFile 'Avica_setup.exe'
          Invoke-WebRequest -Uri 'https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat' -OutFile 'show.bat'
          Invoke-WebRequest -Uri 'https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat' -OutFile 'loop.bat'

          # Install Python packages
          python.exe -m pip install requests pyautogui telegraph --quiet

          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'

          # Set user password
          net user runneradmin TheDisa1a

          Write-Host '⚡ Starting Avica...' -ForegroundColor Yellow
          python -c "import pyautogui as pag; pag.click(897, 64, duration=2)" 2>$null
          Start-Process '.\Avica_setup.exe'

          # Run setup script
          python setup.py

          Write-Host '✅ Setup completed! Check for GoFile link!' -ForegroundColor Green

      - name: Show Connection Info
        shell: pwsh
        run: |
          Write-Host '
          ╔══════════════════════════════════════╗
          ║        AVICA RDP CONNECTION          ║  
          ╚══════════════════════════════════════╝

          📱 Telegram : @TheNetworkZoneOfficial
          👨‍💻 Credits : @PiroYadav & @TheYadavNetwork

          📋 Instructions:
          • Go to the GoFile link that will appear below
          • Get Avica ID and Password from there
          • Download Avica app and connect
          • GoFile link changes every time!

          ⏳ Waiting for GoFile link...
          ' -ForegroundColor Cyan

      - name: Minimize All Windows, Take Screenshot, Upload to GoFile
        shell: pwsh
        run: |
          # Minimize all windows (on desktop environments)
          $code = @"
using System;
using System.Runtime.InteropServices;
public class Win32 {
  [DllImport('user32.dll')]
  [return: MarshalAs(UnmanagedType.Bool)]
  public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
  [DllImport('user32.dll')]
  public static extern IntPtr GetForegroundWindow();
}
"@
          Add-Type $code
          $handle = [Win32]::GetForegroundWindow()
          [Win32]::ShowWindow($handle, 6)
          Start-Sleep -Seconds 2

          python -c "import pyautogui,requests,time;time.sleep(2);ss=pyautogui.screenshot();ss.save('screen.png');with open('screen.png','rb') as f:r=requests.post('https://store1.gofile.io/uploadFile',files={'file':f});print('GoFile response:', r.text)"

      - name: Start Avica Service
        shell: cmd
        run: show.bat

      - name: Keep Session Active
        shell: pwsh
        run: |
          Write-Host '🚀 Avica is starting... Look for CONNECTION ID below!' -ForegroundColor Yellow
          cmd /c loop.bat
