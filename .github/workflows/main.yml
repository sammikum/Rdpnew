name: AvicaRDP
on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Custom username for RDP access'
        required: false
        default: 'runneradm'
      password:
        description: 'Custom password for RDP access'
        required: false
        default: 'Sammiraj123!'
  schedule:
    - cron: '0 */6 * * *'  # Auto restart every 6 hours

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350  # Increased time limit
    
    steps:
      - name: Setup Custom User Credentials
        run: |
          # Get inputs or use defaults
          $username = "${{ github.event.inputs.username || 'runneradm' }}"
          $password = "${{ github.event.inputs.password || 'Sammiraj123!' }}"
          
          Write-Host "🔐 Setting up user: $username" -ForegroundColor Cyan
          
          # Create or update user with custom password
          net user $username $password /add
          net localgroup administrators $username /add
          
          # Store credentials for later use
          @"
          Username: $username
          Password: $password
          Computer: $env:COMPUTERNAME
          Generated: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          "@ | Out-File -FilePath "rdp_credentials.txt"
          
          Write-Host "✅ User $username created with custom password" -ForegroundColor Green
          
      - name: Direct Avica Setup
        run: |
          Write-Host "🚀 Starting Avica setup..." -ForegroundColor Green
          
          # Download files directly
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py"
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat"
          
          # Install Python packages
          python.exe -m pip install requests pyautogui telegraph --quiet
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Start Avica
          Write-Host "⚡ Starting Avica..." -ForegroundColor Yellow
          Start-Process "Avica_setup.exe" -Wait
          
          # Run setup script
          python setup.py
          
          Write-Host "✅ Avica setup completed!" -ForegroundColor Green
          
      - name: Upload Credentials to GoFile
        id: gofile_upload
        run: |
          # Check if credentials file exists
          if (Test-Path "rdp_credentials.txt") {
            # Get GoFile server
            $serverResponse = Invoke-RestMethod -Uri "https://api.gofile.io/getServer" -Method GET
            $server = $serverResponse.data.server
            
            # Upload file to GoFile
            $uploadResponse = curl -F "file=@rdp_credentials.txt" "https://$server.gofile.io/uploadFile"
            $downloadUrl = $uploadResponse.data.downloadPage
            
            # Set output for next steps
            echo "downloadUrl=$downloadUrl" >> $env:GITHUB_OUTPUT
            Write-Host "✅ GoFile upload successful!"
          }
          
          # Also check for Avica-generated credentials
          if (Test-Path "credentials.txt") {
            $serverResponse = Invoke-RestMethod -Uri "https://api.gofile.io/getServer" -Method GET
            $server = $serverResponse.data.server
            $uploadResponse = curl -F "file=@credentials.txt" "https://$server.gofile.io/uploadFile"
            $avicaUrl = $uploadResponse.data.downloadPage
            echo "avicaUrl=$avicaUrl" >> $env:GITHUB_OUTPUT
            Write-Host "✅ Avica credentials uploaded!"
          }
          
      - name: Display Connection Info
        run: |
          Write-Host "
          ╔══════════════════════════════════════╗
          ║        AVICA RDP CONNECTION          ║  
          ╚══════════════════════════════════════╝
          
          📱 Telegram : @TheNetworkZoneOfficial
          👨‍💻 Credits : @PiroYadav & @TheYadavNetwork
          
          🔐 CUSTOM RDP CREDENTIALS:
          • Username: ${{ github.event.inputs.username || 'runneradmin' }}
          • Password: ${{ github.event.inputs.password || 'SecurePass123!' }}
          • Computer: $env:COMPUTERNAME
          
          📋 RDP Connection:
          • Use Windows RDP client
          • Connect to: $env:COMPUTERNAME
          • Use credentials above
          
          🔗 GoFile Links:
          • RDP Credentials: ${{ steps.gofile_upload.outputs.downloadUrl }}
          • Avica Credentials: ${{ steps.gofile_upload.outputs.avicaUrl }}
          
          ⚠️  Links will expire after some time!
          " -ForegroundColor Cyan
          
      - name: Cleanup Sensitive Files
        run: |
          # Remove credential files
          Remove-Item -Path "rdp_credentials.txt" -ErrorAction SilentlyContinue
          Remove-Item -Path "credentials.txt" -ErrorAction SilentlyContinue
          Remove-Item -Path "*password*" -ErrorAction SilentlyContinue
          Remove-Item -Path "*credential*" -ErrorAction SilentlyContinue
          Write-Host "🧹 Cleaned up sensitive files" -ForegroundColor Green
          
      - name: Start Avica Service
        run: cmd /c show.bat
        
      - name: Keep Session Active
        run: |
          Write-Host "🚀 Avica is starting... Use credentials above for RDP access!" -ForegroundColor Yellow
          cmd /c loop.bat
