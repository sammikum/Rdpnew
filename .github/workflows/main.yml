name: AvicaRDP-Advanced-GoFile

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Auto restart every 6 hours

jobs:
  build:
    name: Avica RDP Advanced with GoFile
    runs-on: windows-latest
    timeout-minutes: 350
    
    steps:
      - name: System Preparation
        run: |
          Write-Host "üöÄ Preparing system for AvicaRDP..." -ForegroundColor Green
          choco install 7zip -y --no-progress
          
      - name: Download Required Files
        run: |
          Write-Host "üì• Downloading setup files..." -ForegroundColor Cyan
          
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py"
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat"
          
          # Integrity check (optional, replace with real hash)
          $hash = (Get-FileHash "Avica_setup.exe" -Algorithm SHA256).Hash
          if ($hash -ne "EXPECTED_HASH_HERE") {
              Write-Host "‚ùå Hash mismatch! Possible tampering detected." -ForegroundColor Red
              exit 1
          }
      
      - name: Install Python Dependencies
        run: |
          python.exe -m pip install requests pyautogui psutil --quiet
      
      - name: Enable RDP Access
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "‚úÖ RDP enabled" -ForegroundColor Green

      - name: Configure User Account
        run: |
          net user runneradmin $env:RDP_PASS
          Write-Host "üîê System user password set securely" -ForegroundColor Yellow
        env:
          RDP_PASS: ${{ secrets.RDP_PASSWORD }}

      - name: Start Avica Installer
        run: |
          Write-Host "‚ö° Starting Avica installer..." -ForegroundColor Cyan
          Start-Process "Avica_setup.exe" -Wait
          python setup.py
          Write-Host "‚úÖ Avica installation finished!" -ForegroundColor Green

      - name: Collect Avica Credentials
        run: |
          # Simulate Avica outputting an ID/Password to a text file
          Write-Output "AvicaID=123-456-789" | Out-File connection.txt -Append
          Write-Output "Password=$env:RDP_PASS" | Out-File connection.txt -Append
        env:
          RDP_PASS: ${{ secrets.RDP_PASSWORD }}

      - name: Upload to GoFile
        run: |
          python - <<EOF
          import requests
          url = "https://store1.gofile.io/contents/uploadfile"
          files = {'file': open('connection.txt','rb')}
          upload = requests.post(url, files=files)
          if upload.status_code == 200:
              link = upload.json().get("data", {}).get("downloadPage")
              with open("gofile_link.txt","w") as f:
                  f.write(link or "Error: No link returned")
              print(f"‚úÖ GoFile Link: {link}")
          else:
              print("‚ùå Failed to upload connection info to GoFile")
          EOF

      - name: Show Connection Info
        run: |
          Write-Host "
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë          AVICA RDP - ADVANCED MODE          ‚ïë
          ‚ïë    Connection Info uploaded to GoFile       ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          " -ForegroundColor Cyan
          
          Get-Content gofile_link.txt

      - name: Start Avica Service
        run: cmd /c show.bat

      - name: Keep Session Alive
        run: cmd /c loop.bat

